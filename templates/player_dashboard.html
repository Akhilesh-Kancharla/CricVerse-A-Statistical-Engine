<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CricVerse: Player Insight Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --glass-bg: rgba(23, 23, 23, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --accent-color: #d1d5db; /* Gray-400 */
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
        }
        #bg-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; 
            background-image: url('https://img.freepik.com/premium-photo/cricket-batting-pads-fielding-helmet-resting-beside_1247965-29138.jpg?semt=ais_hybrid&w=740'); 
            background-size: cover; background-position: center; 
            filter: grayscale(100%) brightness(0.5); 
        }
        .bg-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, rgba(10, 10, 10, 0.7), var(--bg-color) 70%);
            z-index: -1; 
        }
        .glass-container { 
            background: var(--glass-bg); 
            border-radius: 16px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); 
            border: 1px solid var(--border-color); 
            border-top: 1px solid rgba(209, 213, 219, 0.3);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
            border-top-color: rgba(209, 213, 219, 0.6);
        }
        .chartjs-tooltip { background: rgba(0, 0, 0, 0.8) !important; border-radius: 8px !important; }
        .chartjs-render-monitor { animation: chart-fade-in 1s ease-out forwards; }
        @keyframes chart-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .error-message { color: #f87171; text-align: center; font-size: 1.25rem; }
        .chart-wrapper { position: relative; height: 320px; width: 100%; }
        .stat-value { color: var(--text-primary); }
        .stat-label { color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        .card-header { display: flex; align-items: center; gap: 0.75rem; font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; color: var(--accent-color);}
        
        /* Loader */
        .loader-wrapper { display: flex; justify-content: center; align-items: center; min-height: 60vh; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--text-primary); border-bottom-color: var(--accent-color); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .back-link {
            display: inline-block;
            margin-bottom: 2.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .back-link:hover {
            color: var(--accent-color);
        }
        /* Tab Styles */
        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .tab-btn.active, .tab-btn:hover {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        /* IMPROVEMENT: Style for disabled tab */
        .tab-btn:disabled {
            color: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            border-bottom-color: transparent;
        }
        .stats-card {
            display: flex;
            flex-direction: column;
            min-height: 340px;
        }
        .stats-grid {
            flex-grow: 1;
            display: grid;
            align-content: center;
        }
        @keyframes tab-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-content { display: none; }
        .tab-content.active {
            display: block;
            animation: tab-fade-in 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="bg-container"></div>
    <div class="bg-overlay"></div>
    
    <main class="max-w-7xl mx-auto">
        <a href="/" class="back-link">&larr; Back to Search</a>
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-black tracking-tighter" id="player-name-header">Player Dashboard</h1>
            <p class="text-lg md:text-xl text-gray-400 mt-2" id="player-name">Loading player data...</p>
        </header>

        <div id="loader" class="loader-wrapper">
            <div class="loader"></div>
        </div>

        <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6 opacity-0 transition-opacity duration-500">
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="glass-container">
                    <div class="card-header">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <h3>Player Details</h3>
                    </div>
                    <div class="flex items-center space-x-4">
                        <img id="player-image" src="https://placehold.co/80x80/1a202c/ffffff?text=?" alt="Player Image" class="w-20 h-20 rounded-full bg-gray-700 object-cover border-2 border-gray-600" onerror="this.src='https://placehold.co/80x80/1a202c/ffffff?text=?';">
                        <div>
                            <p id="player-batting-style" class="text-gray-300">Batting: <span class="font-semibold text-white">--</span></p>
                            <p id="player-bowling-style" class="text-gray-300">Bowling: <span class="font-semibold text-white">--</span></p>
                        </div>
                    </div>
                </div>
                <div class="glass-container stats-card">
                    <div class="card-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.5 2.5c2.3-2.3 6.2-2.3 8.5 0l-1.1 1.1c-1.7-1.7-4.4-1.7-6.1 0l1.1-1.1z"/><path d="m2.1 14.1 3.5-3.5"/><path d="m11.1 11.1-3.5 3.5"/><path d="m14.2 8-3.5 3.5"/><path d="m5.6 17.6 3.5-3.5"/><path d="M12.5 12.5c2.3 2.3 2.3 6.2 0 8.5l1.1 1.1c1.7-1.7 1.7-4.4 0-6.1l-1.1-1.1z"/><path d="M3.9 12.1c-1.7-1.7-1.7-4.4 0-6.1l1.1 1.1c-1.1 1.1-1.1 3.1 0 4.1l-1.1 1.1z"/><path d="M12 3.9c1.7 1.7 1.7 4.4 0 6.1l-1-1.1c1.1-1.1 1.1-3.1 0-4.1l1.1-1z"/></svg>
                        <h3>Batting Summary</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-y-4 gap-x-2 stats-grid">
                        <div class="text-center"><p class="stat-label">Total Runs</p><p id="total-runs" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">High Score</p><p id="high-score" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">Average</p><p id="batting-average" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">Strike Rate</p><p id="strike-rate" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">100s</p><p id="hundreds" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">50s</p><p id="fifties" class="text-4xl font-bold stat-value">--</p></div>
                    </div>
                </div>
                <div id="bowling-summary-card" class="glass-container stats-card">
                    <div class="card-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M15.42 8.58a4.34 4.34 0 1 0-6.13 6.13 4.34 4.34 0 1 0 6.13-6.13Z"/></svg>
                        <h3>Bowling Summary</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-y-4 gap-x-2 stats-grid">
                        <div class="text-center"><p class="stat-label">Wickets</p><p id="total-wickets" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">Average</p><p id="bowling-average-stat" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">Economy</p><p id="economy-rate" class="text-4xl font-bold stat-value">--</p></div>
                        <div class="text-center"><p class="stat-label">Best Figures</p><p id="best-figures" class="text-3xl font-bold stat-value">--</p></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-container chart-fade-in" style="animation-delay: 100ms;">
                        <h3 class="text-xl font-bold mb-4 text-center">Performance Snapshot</h3>
                        <div class="chart-wrapper"><canvas id="performanceRadarChart"></canvas></div>
                    </div>
                    <div id="dismissal-chart-card" class="glass-container chart-fade-in" style="animation-delay: 200ms;">
                        <h3 class="text-xl font-bold mb-4 text-center">Dismissal Types</h3>
                        <div class="chart-wrapper"><canvas id="dismissalPieChart"></canvas></div>
                    </div>
                    <div id="seasonal-stats-card" class="glass-container md:col-span-2 chart-fade-in" style="animation-delay: 300ms;">
                        <div id="seasonal-tabs" class="flex border-b border-[var(--border-color)] mb-4" role="tablist">
                            <button id="runs-tab" class="tab-btn active font-semibold" role="tab" aria-controls="runsPerSeasonWrapper" aria-selected="true">Runs Per Season</button>
                            <button id="wickets-tab" class="tab-btn font-semibold" role="tab" aria-controls="wicketsPerSeasonWrapper" aria-selected="false">Wickets Per Season</button>
                        </div>
                        <div id="runsPerSeasonWrapper" class="tab-content active" role="tabpanel" aria-labelledby="runs-tab">
                            <div class="chart-wrapper"><canvas id="runsPerSeasonChart"></canvas></div>
                        </div>
                        <div id="wicketsPerSeasonWrapper" class="tab-content" role="tabpanel" aria-labelledby="wickets-tab">
                            <div class="chart-wrapper"><canvas id="wicketsPerSeasonChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accentColor = '#d1d5db';
            const gridColor = 'rgba(255, 255, 255, 0.2)';
            const textColor = 'rgba(255, 255, 255, 0.8)';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            Chart.defaults.font.family = "'Inter', sans-serif";

            const elements = {
                loader: document.getElementById('loader'),
                dashboardContent: document.getElementById('dashboard-content'),
                playerNameHeader: document.getElementById('player-name-header'),
                playerNameSub: document.getElementById('player-name'),
                playerImage: document.getElementById('player-image'),
                playerBattingStyle: document.getElementById('player-batting-style'),
                playerBowlingStyle: document.getElementById('player-bowling-style'),
                totalRuns: document.getElementById('total-runs'),
                highScore: document.getElementById('high-score'),
                battingAverage: document.getElementById('batting-average'),
                strikeRate: document.getElementById('strike-rate'),
                hundreds: document.getElementById('hundreds'),
                fifties: document.getElementById('fifties'),
                bowlingSummaryCard: document.getElementById('bowling-summary-card'),
                totalWickets: document.getElementById('total-wickets'),
                bowlingAverageStat: document.getElementById('bowling-average-stat'),
                economyRate: document.getElementById('economy-rate'),
                bestFigures: document.getElementById('best-figures'),
                dismissalChartCard: document.getElementById('dismissal-chart-card'),
                seasonalTabs: document.getElementById('seasonal-tabs'),
                runsTab: document.getElementById('runs-tab'),
                wicketsTab: document.getElementById('wickets-tab'),
                runsWrapper: document.getElementById('runsPerSeasonWrapper'),
                wicketsWrapper: document.getElementById('wicketsPerSeasonWrapper'),
            };

             // Tab switching logic
            elements.runsTab.addEventListener('click', () => {
                if (elements.runsTab.classList.contains('active')) return;
                elements.runsTab.classList.add('active');
                elements.runsTab.setAttribute('aria-selected', 'true');
                elements.wicketsTab.classList.remove('active');
                elements.wicketsTab.setAttribute('aria-selected', 'false');
                elements.wicketsWrapper.classList.remove('active');
                elements.runsWrapper.classList.add('active');
            });

            elements.wicketsTab.addEventListener('click', () => {
                if (elements.wicketsTab.classList.contains('active')) return;
                elements.wicketsTab.classList.add('active');
                elements.wicketsTab.setAttribute('aria-selected', 'true');
                elements.runsTab.classList.remove('active');
                elements.runsTab.setAttribute('aria-selected', 'false');
                elements.runsWrapper.classList.remove('active');
                elements.wicketsWrapper.classList.add('active');
            });

            const initCharts = () => {
                const charts = {};
                const perfCtx = document.getElementById('performanceRadarChart').getContext('2d');
                const radarGradient = perfCtx.createLinearGradient(0, 0, 0, 300);
                radarGradient.addColorStop(0, 'rgba(209, 213, 219, 0.5)');
                radarGradient.addColorStop(1, 'rgba(209, 213, 219, 0.1)');
                charts.performance = new Chart(perfCtx, { type: 'radar', data: { labels: [], datasets: [{ label: 'Performance Score', data: [], fill: true, backgroundColor: radarGradient, borderColor: accentColor, pointBackgroundColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { r: { suggestedMin: 0, suggestedMax: 100, grid: { color: gridColor }, angleLines: { color: gridColor }, pointLabels: { font: { size: 12 }, color: textColor } } } } });
                const dismissalCtx = document.getElementById('dismissalPieChart').getContext('2d');
                charts.dismissal = new Chart(dismissalCtx, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#6b7280', '#9ca3af', '#d1d5db', '#e5e7eb', '#f3f4f6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 15 } } } } });
                const runsCtx = document.getElementById('runsPerSeasonChart').getContext('2d');
                const barGradient = runsCtx.createLinearGradient(0, 0, 0, 300);
                barGradient.addColorStop(0, accentColor);
                barGradient.addColorStop(1, 'rgba(209, 213, 219, 0.3)');
                charts.runs = new Chart(runsCtx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Total Runs', data: [], backgroundColor: barGradient, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor } }, x: { grid: { display: false } } } } });
                const wicketsCtx = document.getElementById('wicketsPerSeasonChart').getContext('2d');
                const lineGradient = wicketsCtx.createLinearGradient(0, 0, 0, 300);
                lineGradient.addColorStop(0, 'rgba(209, 213, 219, 0.4)');
                lineGradient.addColorStop(1, 'rgba(209, 213, 219, 0)');
                charts.wickets = new Chart(wicketsCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'Total Wickets', data: [], fill: true, borderColor: accentColor, backgroundColor: lineGradient, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor } }, x: { grid: { display: false } } } } });
                return charts;
            };

            const charts = initCharts();

            const updateDashboard = (data) => {
                elements.loader.style.display = 'none';
                elements.dashboardContent.style.opacity = 1;

                elements.playerNameHeader.textContent = data.name;
                elements.playerNameSub.textContent = `Career Performance Dashboard`;
                elements.playerBattingStyle.innerHTML = `Batting: <span class="font-semibold text-white">${data.details.battingStyle || 'N/A'}</span>`;
                elements.playerBowlingStyle.innerHTML = `Bowling: <span class="font-semibold text-white">${data.details.bowlingStyle || 'N/A'}</span>`;
                if(data.details && data.details.imagePath) {
                    elements.playerImage.src = data.details.imagePath;
                }

                elements.totalRuns.textContent = data.batting.totalRuns;
                elements.highScore.textContent = data.batting.highScore;
                elements.battingAverage.textContent = data.batting.average;
                elements.strikeRate.textContent = data.batting.strikeRate;
                elements.hundreds.textContent = data.batting.hundreds;
                elements.fifties.textContent = data.batting.fifties;
                
                if (data.bowling.totalWickets > 0) {
                    elements.totalWickets.textContent = data.bowling.totalWickets;
                    elements.bowlingAverageStat.textContent = data.bowling.average;
                    elements.economyRate.textContent = data.bowling.economy;
                    elements.bestFigures.textContent = data.bowling.bestFigures;
                    elements.bowlingSummaryCard.style.display = 'block';
                } else {
                    elements.bowlingSummaryCard.style.display = 'none';
                }

                charts.performance.data.labels = Object.keys(data.performance);
                charts.performance.data.datasets[0].data = Object.values(data.performance);
                charts.performance.update();
                
                const hasDismissals = Object.keys(data.batting.dismissalTypes).length > 0;
                elements.dismissalChartCard.style.display = hasDismissals ? 'block' : 'none';
                if (hasDismissals) {
                    charts.dismissal.data.labels = Object.keys(data.batting.dismissalTypes);
                    charts.dismissal.data.datasets[0].data = Object.values(data.batting.dismissalTypes);
                    charts.dismissal.update();
                }

                charts.runs.data.labels = Object.keys(data.runsPerSeason);
                charts.runs.data.datasets[0].data = Object.values(data.runsPerSeason);
                charts.runs.update();
                
                const hasWickets = Object.keys(data.wicketsPerSeason).length > 0;
                elements.seasonalTabs.style.display = 'flex'; // Always show the tab container

                if (hasWickets) {
                    elements.wicketsTab.disabled = false;
                    charts.wickets.data.labels = Object.keys(data.wicketsPerSeason);
                    charts.wickets.data.datasets[0].data = Object.values(data.wicketsPerSeason);
                    charts.wickets.update();
                } else {
                    elements.wicketsTab.disabled = true;
                    // Ensure the runs tab is active if the wickets tab is disabled
                    if (!elements.runsTab.classList.contains('active')) {
                        elements.runsTab.click();
                    }
                }
            };

            const displayError = (message) => {
                 elements.loader.style.display = 'none';
                 elements.dashboardContent.style.opacity = 1;
                 elements.playerNameSub.textContent = 'Error';
                 elements.dashboardContent.innerHTML = `<div class="lg:col-span-3"><div class="glass-container error-message mt-8">${message}</div></div>`;
            }
            
            const fetchAndDisplayPlayerData = async (playerName) => {
                if (!playerName) { displayError("No player specified. Please go back and search for a player."); return; }
                try {
                    const response = await fetch(`/api/player_data/${encodeURIComponent(playerName)}`);
                    const data = await response.json();
                    if (!response.ok) { throw new Error(data.error || 'Could not fetch player data.'); }
                    updateDashboard(data);
                } catch (error) {
                    console.error('Fetch error:', error);
                    displayError(error.message);
                }
            };
            
            const urlParams = new URLSearchParams(window.location.search);
            const playerName = urlParams.get('name');
            fetchAndDisplayPlayerData(playerName);
        });
    </script>
</body>
</html>