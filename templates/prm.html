<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>CricVerse: Pressure Resistance Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000; 
            color: #f9fafb;
        }
        #bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-image: url('https://img.freepik.com/premium-photo/cricket-batting-pads-fielding-helmet-resting-beside_1247965-29138.jpg?semt=ais_hybrid&w=740');
            background-size: cover;
            background-position: center;
            filter: grayscale(100%) brightness(0.5);
        }
        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }
        .glass-pane {
            background-color: rgba(25, 25, 25, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }

        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="antialiased">
    <div id="bg-container"></div>
    <div class="bg-overlay"></div>
    <div id="root"></div>

    <script type="text/babel">
    {% raw %}
        const { useState, useEffect, useMemo, useRef } = React;

        const fetchPlayersAPI = async (searchQuery) => {
            // Use a relative URL to fetch from the backend serving this page
            const url = `/api/prm_data?search=${encodeURIComponent(searchQuery)}`;
            const response = await fetch(url);
            if (!response.ok) {
                console.error("Failed to fetch PRM data");
                return [];
            }
            const data = await response.json();
            // Map API response keys (e.g., player_name) to component prop names (e.g., name)
            return data.map(p => ({
                id: p.id,
                name: p.player_name,
                role: p.role,
                batPrs: p.batting_prs,
                bowlPrs: p.bowling_prs,
                batBalls: p.bat_balls,
                bowlBalls: p.bowl_balls
            }));
        };

        const getArchetype = (player) => {
            const { batPrs, bowlPrs, batBalls, bowlBalls } = player;
            const totalExperience = (batBalls || 0) + (bowlBalls || 0);

            if (batPrs > 88 && batPrs > (bowlPrs || 0)) return { type: "The Finisher", color: "bg-sky-500" };
            if (bowlPrs > 88 && bowlPrs > (batPrs || 0)) return { type: "Death Specialist", color: "bg-red-500" };
            if (batPrs > 78 && bowlPrs > 78) return { type: "Elite All-Rounder", color: "bg-emerald-500" };
            if (batPrs > 68 && bowlPrs > 68) return { type: "Utility All-Rounder", color: "bg-green-500" };
            if (player.role === 'Batsman' && batPrs > 80) return { type: "Anchor Batsman", color: "bg-blue-500" };
            if (player.role === 'Bowler' && bowlPrs > 80) return { type: "Lead Bowler", color: "bg-rose-500" };
            if (totalExperience > 1500) return { type: "The Veteran", color: "bg-purple-500"};
            return { type: "Developing Talent", color: "bg-gray-500"};
        };
        
        const RadialGauge = ({ score, label, color, isWinner }) => {
            const size = 120;
            const strokeWidth = 12;
            const radius = (size - strokeWidth) / 2;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score / 100) * circumference;

            return (
                <div className="flex flex-col items-center justify-center">
                    <div className={`relative w-32 h-32 transition-transform duration-300 ${isWinner ? 'scale-110' : ''}`}>
                        <svg className="w-full h-full" viewBox={`0 0 ${size} ${size}`}>
                            <circle className="text-gray-700" stroke="currentColor" strokeWidth={strokeWidth} fill="transparent" r={radius} cx={size/2} cy={size/2} />
                            <circle
                                className={color}
                                stroke="currentColor" strokeWidth={strokeWidth} strokeDasharray={circumference}
                                strokeDashoffset={offset} strokeLinecap="round" fill="transparent"
                                r={radius} cx={size/2} cy={size/2}
                                style={{ transform: 'rotate(-90deg)', transformOrigin: '50% 50%', transition: 'stroke-dashoffset 0.8s ease-out, stroke 0.3s' }}
                            />
                        </svg>
                        <span className={`absolute inset-0 flex items-center justify-center text-3xl font-bold transition-colors duration-300 ${isWinner ? 'text-white' : 'text-gray-300'}`}>{score || 0}</span>
                    </div>
                    <p className="mt-2 text-sm font-semibold text-gray-300">{label}</p>
                </div>
            );
        };

        const FeaturedPlayer = ({ player, comparePlayer = null }) => {
            if (!player) {
                return (
                    <div className="glass-pane w-full h-full flex items-center justify-center p-8 text-center min-h-[400px]">
                        <div>
                            <h2 className="text-2xl font-bold text-white">Select a Player</h2>
                            <p className="text-gray-400 mt-2">Click a player to see their stats or toggle Compare Mode.</p>
                        </div>
                    </div>
                );
            }

            const archetype = getArchetype(player);
            const compareArchetype = comparePlayer ? getArchetype(comparePlayer) : null;

            const batWinner = comparePlayer ? ((player.batPrs || 0) > (comparePlayer.batPrs || 0) ? 'player1' : (player.batPrs || 0) < (comparePlayer.batPrs || 0) ? 'player2' : 'tie') : 'none';
            const bowlWinner = comparePlayer ? ((player.bowlPrs || 0) > (comparePlayer.bowlPrs || 0) ? 'player1' : (player.bowlPrs || 0) < (comparePlayer.bowlPrs || 0) ? 'player2' : 'tie') : 'none';

            const batColor = player.batPrs > 85 ? 'text-cyan-400' : player.batPrs > 70 ? 'text-green-400' : 'text-yellow-400';
            const bowlColor = player.bowlPrs > 85 ? 'text-cyan-400' : player.bowlPrs > 70 ? 'text-green-400' : 'text-yellow-400';
            
            const compareBatColor = comparePlayer ? (comparePlayer.batPrs > 85 ? 'text-cyan-400' : comparePlayer.batPrs > 70 ? 'text-green-400' : 'text-yellow-400') : '';
            const compareBowlColor = comparePlayer ? (comparePlayer.bowlPrs > 85 ? 'text-cyan-400' : comparePlayer.bowlPrs > 70 ? 'text-green-400' : 'text-yellow-400') : '';

            return (
                 <div className="glass-pane w-full h-full p-8 flex flex-col justify-between">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                        {/* Player 1 Details */}
                        <div className="text-center md:text-left">
                            <h2 className="text-3xl lg:text-4xl font-black text-white text-glow tracking-tight">{player.name}</h2>
                            <div className="flex items-center justify-center md:justify-start gap-2 mt-2">
                                <span className={`px-3 py-1 text-xs font-semibold text-white rounded-full ${archetype.color}`}>{archetype.type}</span>
                                <p className="text-md text-blue-300 font-semibold">{player.role}</p>
                            </div>
                        </div>
                        {/* Player 2 Details or VS prompt */}
                        <div className="text-center md:text-right">
                             {comparePlayer ? (
                                <>
                                    <h2 className="text-3xl lg:text-4xl font-black text-white text-glow tracking-tight">{comparePlayer.name}</h2>
                                    <div className="flex items-center justify-center md:justify-end gap-2 mt-2">
                                        <span className={`px-3 py-1 text-xs font-semibold text-white rounded-full ${compareArchetype.color}`}>{compareArchetype.type}</span>
                                        <p className="text-md text-blue-300 font-semibold">{comparePlayer.role}</p>
                                    </div>
                                </>
                             ) : (
                                <div className="hidden md:block text-gray-500">
                                    <p className="font-bold text-lg">VS</p>
                                    <p className="text-sm">Enable Compare Mode to select another player</p>
                                </div>
                             )}
                        </div>
                    </div>
                    {/* Gauges */}
                    <div className="grid grid-cols-2 gap-4 my-8">
                        <div className="flex flex-col md:flex-row items-center justify-around gap-4">
                            {player.batPrs !== null && <RadialGauge score={player.batPrs} label="Batting PRS" color={batColor} isWinner={batWinner === 'player1'} />}
                            {player.bowlPrs !== null && <RadialGauge score={player.bowlPrs} label="Bowling PRS" color={bowlColor} isWinner={bowlWinner === 'player1'} />}
                        </div>
                         <div className="flex flex-col md:flex-row items-center justify-around gap-4 border-l border-white/10">
                            {comparePlayer ? (
                                <>
                                    {comparePlayer.batPrs !== null && <RadialGauge score={comparePlayer.batPrs} label="Batting PRS" color={compareBatColor} isWinner={batWinner === 'player2'}/>}
                                    {comparePlayer.bowlPrs !== null && <RadialGauge score={comparePlayer.bowlPrs} label="Bowling PRS" color={compareBowlColor} isWinner={bowlWinner === 'player2'}/>}
                                </>
                            ) : null}
                        </div>
                    </div>
                    {/* Stats */}
                    <div className="grid grid-cols-2 gap-4 text-center text-sm glass-pane bg-black/20 p-4">
                         <div className="border-r border-white/10">
                             <p className="text-gray-400">Pressure Balls Faced</p>
                             <p className="font-bold text-xl text-white">{player.batBalls || 'N/A'}</p>
                             <p className="text-gray-400 mt-2">Pressure Balls Bowled</p>
                             <p className="font-bold text-xl text-white">{player.bowlBalls || 'N/A'}</p>
                         </div>
                         <div>
                             <p className="text-gray-400">Pressure Balls Faced</p>
                             <p className="font-bold text-xl text-white">{comparePlayer ? comparePlayer.batBalls || 'N/A' : '-'}</p>
                             <p className="text-gray-400 mt-2">Pressure Balls Bowled</p>
                             <p className="font-bold text-xl text-white">{comparePlayer ? comparePlayer.bowlBalls || 'N/A' : '-'}</p>
                         </div>
                     </div>
                 </div>
            );
        };
        
        const PlayerCard = ({ player, onSelect, isSelected }) => {
            const roleColor = player.role === 'Batsman' ? 'border-blue-500' : player.role === 'Bowler' ? 'border-red-500' : 'border-green-500';
            return (
                <div 
                    onClick={() => onSelect(player)}
                    className={`p-4 glass-pane flex items-center justify-between hover:border-blue-400 transition-all duration-200 cursor-pointer rounded-lg ${roleColor} border-l-4 ${isSelected ? 'bg-blue-500/30 border-blue-400' : 'border-transparent'}`}
                >
                    <div className="flex-grow">
                        <p className="font-bold text-white truncate">{player.name}</p>
                        <p className="text-xs text-gray-400">{player.role}</p>
                    </div>
                     <div className="flex gap-4 text-xs">
                        <div className="text-center w-12">
                            <p className="text-gray-400">BAT</p>
                            <p className="font-semibold text-lg text-white">{player.batPrs || '-'}</p>
                        </div>
                        <div className="text-center w-12">
                            <p className="text-gray-400">BOWL</p>
                            <p className="font-semibold text-lg text-white">{player.bowlPrs || '-'}</p>
                        </div>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [players, setPlayers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [comparisonPlayers, setComparisonPlayers] = useState([]);
            const [isCompareMode, setCompareMode] = useState(false);
            const [search, setSearch] = useState('');

            useEffect(() => {
                setLoading(true);
                // Debounce search to avoid excessive API calls while typing
                const timer = setTimeout(() => {
                    fetchPlayersAPI(search).then(data => {
                        setPlayers(data);
                        if (comparisonPlayers.length === 0 && data.length > 0) {
                            setComparisonPlayers([data.find(p => p.name === 'MS Dhoni') || data[0]]);
                        }
                        setLoading(false);
                    });
                }, 300); // Wait 300ms after user stops typing
                return () => clearTimeout(timer);
            }, [search]);
            
            const handlePlayerSelect = (player) => {
                if (isCompareMode) {
                    setComparisonPlayers(prev => {
                        if (prev.find(p => p.id === player.id)) return prev; // Already selected
                        const newSelection = [...prev, player];
                        return newSelection.slice(-2); // Keep only the last 2 selected
                    });
                } else {
                    setComparisonPlayers([player]);
                }
            };
            
            const toggleCompareMode = () => {
                setCompareMode(!isCompareMode);
                if (isCompareMode && comparisonPlayers.length > 1) {
                    setComparisonPlayers([comparisonPlayers[0]]); // Keep only the first player when exiting compare mode
                }
            };

            const selectedIds = useMemo(() => new Set(comparisonPlayers.map(p => p.id)), [comparisonPlayers]);

            return (
                <div className="min-h-screen p-6 md:p-12 flex flex-col">
                    <header className="text-center mb-12 fade-in-up">
                        <h1 className="text-4xl md:text-5xl font-black tracking-tighter text-white">Pressure Resistance Explorer</h1>
                        <p className="text-lg text-gray-400 max-w-3xl mx-auto mt-2">
                           Select one player for an overview, or activate Compare Mode to see two players head-to-head.
                        </p>
                    </header>
                    
                    <main className="flex-grow flex flex-col gap-12">
                        <div className="fade-in-up" style={{animationDelay: '150ms'}}>
                             <FeaturedPlayer player={comparisonPlayers[0]} comparePlayer={comparisonPlayers[1]} />
                        </div>
                        <div className="flex flex-col gap-4 fade-in-up" style={{animationDelay: '300ms'}}>
                             <div className="flex gap-4">
                                <input
                                    type="text" value={search} onChange={(e) => setSearch(e.target.value)}
                                    placeholder="Search players..."
                                    className="w-full bg-black/30 glass-pane border-transparent focus:border-blue-500 focus:ring-0 rounded-lg p-3 placeholder-gray-400"
                                />
                                 <button onClick={toggleCompareMode} className={`px-4 py-2 rounded-lg font-semibold transition-colors ${isCompareMode ? 'bg-blue-600 text-white' : 'bg-white/10 hover:bg-white/20'}`}>
                                     {isCompareMode ? 'Comparing' : 'Compare'}
                                 </button>
                             </div>
                            <div className="glass-pane flex-grow p-6">
                               {loading ? ( <div className="text-center py-10 text-gray-400">Loading...</div> ) : (
                                   <div className="space-y-3 max-h-[40vh] overflow-y-auto pr-2">
                                       {players.map(player => (
                                           <PlayerCard 
                                               key={player.id} player={player} onSelect={handlePlayerSelect}
                                               isSelected={selectedIds.has(player.id)}
                                           />
                                       ))}
                                   </div>
                               )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    {% endraw %}
    </script>
</body>
</html>